@page "/bills"
@inject BillService BillService
@inject NavigationManager Nav

<div class="container py-4">

    <!-- PAGE HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">
            <i class="bi bi-receipt-cutoff me-2"></i> Bills Management
        </h2>
    </div>

    <!-- ALERT MESSAGES -->
    @if (!string.IsNullOrEmpty(AlertMessage))
    {
        <div class="alert alert-@(IsError ? "danger" : "success") alert-dismissible fade show" role="alert">
            @AlertMessage
            <button type="button" class="btn-close" @onclick="() => AlertMessage = string.Empty"></button>
        </div>
    }

    <!-- ACTION BAR -->
    <div class="d-flex flex-wrap gap-2 align-items-center mb-3">

        <button class="btn btn-primary" @onclick="LoadBills">
            <i class="bi bi-arrow-repeat me-1"></i> Refresh
        </button>

        <button class="btn btn-success" @onclick="OpenModal">
            <i class="bi bi-plus-lg me-1"></i> New Bill
        </button>

        <div class="ms-auto d-flex gap-2">
            <input class="form-control" style="max-width: 250px;"
                   placeholder="Search by ID or Payee..."
                   @bind="SearchText"
                   @bind:event="oninput" />

            <button class="btn btn-outline-secondary" @onclick="() => SearchText = string.Empty">
                Clear
            </button>
        </div>

    </div>

    <!-- TABLE CARD -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover table-striped align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Payee</th>
                        <th>Due Date</th>
                        <th>Amount</th>
                        <th>Paid</th>
                        <th style="width: 160px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var bill in FilteredBills)
                    {
                        <tr>
                            <td>@bill.Id</td>
                            <td>@bill.PayeeName</td>
                            <td>@bill.DueDate?.ToShortDateString()</td>
                            <td>$@bill.PaymentDue</td>
                            <td>
                                @if (bill.Paid)
                                {
                                    <span class="badge bg-success">Yes</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">No</span>
                                }
                            </td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-secondary"
                                        @onclick="() => OpenEditModal(bill)">
                                    <i class="bi bi-pencil"></i>
                                </button>

                                    <button class="btn btn-sm btn-danger"
                                            @onclick="() => OpenDeleteModal(bill)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- DELETE MODAL -->
@if (ShowDeleteModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i> Delete Bill</h5>
                    <button type="button" class="btn-close" @onclick="CloseDeleteModal"></button>
                </div>

                <div class="modal-body">
                    <p>Are you sure you want to delete this bill?</p>

                    <ul>
                        <li><strong>Payee:</strong> @_deleteBill.PayeeName</li>
                        <li><strong>Amount:</strong> @_deleteBill.PaymentDue</li>
                        <li><strong>Due Date:</strong> @_deleteBill.DueDate?.ToShortDateString()</li>
                    </ul>

                    <p class="text-danger fw-bold">This action cannot be undone.</p>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseDeleteModal">Cancel</button>
                    <button class="btn btn-danger" @onclick="ConfirmDelete">Delete</button>
                </div>

            </div>
        </div>
    </div>
}


<!-- EDIT MODAL -->
@if (ShowEditModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i> Edit Bill
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseEditModal"></button>
                </div>

                <EditForm Model="_editBill" OnValidSubmit="SaveEditedBill">
                    <DataAnnotationsValidator />

                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Payee Name</label>
                            <input class="form-control" @bind="_editBill.PayeeName" />
                            <ValidationMessage For="@(() => _editBill.PayeeName)" class="text-danger small" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" @bind="_editBill.DueDate" />
                            <ValidationMessage For="@(() => _editBill.DueDate)" class="text-danger small" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <input type="number" step="0.01" class="form-control" @bind="_editBill.PaymentDue" />
                            <ValidationMessage For="@(() => _editBill.PaymentDue)" class="text-danger small" />
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" @bind="_editBill.Paid" />
                            <label class="form-check-label">Paid</label>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseEditModal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </EditForm>

            </div>
        </div>
    </div>
}


<!-- CREATE MODAL -->
@if (ShowCreateModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-lg me-2"></i> Create Bill
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>

                <EditForm Model="_newBill" OnValidSubmit="SaveNewBill">
                    <DataAnnotationsValidator />

                    <div class="modal-body">

                        <div class="mb-3">
                            <label class="form-label">Payee Name</label>
                            <input class="form-control" @bind="_newBill.PayeeName" />
                            <ValidationMessage For="@(() => _newBill.PayeeName)" class="text-danger small" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" @bind="_newBill.DueDate" />
                            <ValidationMessage For="@(() => _newBill.DueDate)" class="text-danger small" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Amount</label>
                            <input type="number" step="0.01" class="form-control" @bind="_newBill.PaymentDue" />
                            <ValidationMessage For="@(() => _newBill.PaymentDue)" class="text-danger small" />
                        </div>

                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" @bind="_newBill.Paid" />
                            <label class="form-check-label">Paid</label>
                        </div>

                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                        <button type="submit" class="btn btn-success">Save</button>
                    </div>
                </EditForm>

            </div>
        </div>
    </div>
}
